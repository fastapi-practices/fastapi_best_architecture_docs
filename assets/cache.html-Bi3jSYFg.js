import{_ as s,c as a,d as t,o as e}from"./app-BLJpD-6k.js";const n={};function h(l,i){return e(),a("div",null,[...i[0]||(i[0]=[t(`<h2 id="编程式缓存" tabindex="-1"><a class="header-anchor" href="#编程式缓存"><span>编程式缓存</span></a></h2><ul><li>完全手动控制缓存的读写、失效、TTL 等</li><li>适合复杂逻辑、批量操作、自定义序列化、事务等高级场景</li><li>代码较为显式，易于调试，但重复代码多，容易出错</li></ul><h3 id="依赖" tabindex="-1"><a class="header-anchor" href="#依赖"><span>依赖</span></a></h3><p>所有操作都通过 <code>backend/database/redis.py</code> 中的全局 Redis 客户端完成：</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-python"><span class="line"><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#A0A1A7;--shiki-light-font-style:italic;"># 创建 redis 客户端单例</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">redis_client: RedisCli </span><span style="--shiki-dark:#56B6C2;--shiki-light:#383A42;">=</span><span style="--shiki-dark:#61AFEF;--shiki-light:#383A42;"> RedisCli</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">()</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="声明式缓存" tabindex="-1"><a class="header-anchor" href="#声明式缓存"><span>声明式缓存</span></a></h2><ul><li>通过装饰器自动管理缓存生命周期</li><li>代码极简，关注点分离，适合标准 CRUD</li></ul><h3 id="cached" tabindex="-1"><a class="header-anchor" href="#cached"><span>@cached</span></a></h3><p>自动缓存函数结果</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-python"><span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">from</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> backend.common.cache.decorator </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">import</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> cached</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">@cached</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#986801;--shiki-light-font-style:inherit;">name</span><span style="--shiki-dark:#56B6C2;--shiki-light:#383A42;">=</span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">&quot;user:detail&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">,</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#986801;--shiki-light-font-style:inherit;"> key</span><span style="--shiki-dark:#56B6C2;--shiki-light:#383A42;">=</span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">&quot;user_id&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">async</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> def</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> get_user_detail</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#D19A66;--shiki-dark-font-style:italic;--shiki-light:#986801;--shiki-light-font-style:inherit;">user_id</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">:</span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;"> int</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">):</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">    user </span><span style="--shiki-dark:#56B6C2;--shiki-light:#383A42;">=</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> await</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> User.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#383A42;">get_or_none</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#986801;--shiki-light-font-style:inherit;">id</span><span style="--shiki-dark:#56B6C2;--shiki-light:#383A42;">=</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">user_id)</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">    return</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> user.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#383A42;">dict</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">() </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">if</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> user </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">else</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> None</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>第一次调用 → 执行函数 → 缓存结果</li><li>后续调用 → 直接从缓存（L1 或 Redis）返回</li></ul><h3 id="cache-invalidate" tabindex="-1"><a class="header-anchor" href="#cache-invalidate"><span>@cache_invalidate</span></a></h3><p>方法执行后自动失效指定缓存</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-python"><span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">from</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> backend.common.cache.decorator </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">import</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> cache_invalidate</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">@cache_invalidate</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#986801;--shiki-light-font-style:inherit;">name</span><span style="--shiki-dark:#56B6C2;--shiki-light:#383A42;">=</span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">&quot;user:detail&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">,</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#986801;--shiki-light-font-style:inherit;"> key</span><span style="--shiki-dark:#56B6C2;--shiki-light:#383A42;">=</span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">&quot;user_id&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">async</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> def</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> update_user</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#D19A66;--shiki-dark-font-style:italic;--shiki-light:#986801;--shiki-light-font-style:inherit;">user_id</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">:</span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;"> int</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">,</span><span style="--shiki-dark:#D19A66;--shiki-dark-font-style:italic;--shiki-light:#986801;--shiki-light-font-style:inherit;"> name</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">:</span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;"> str</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">):</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">    await</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> User.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#383A42;">filter</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#986801;--shiki-light-font-style:inherit;">id</span><span style="--shiki-dark:#56B6C2;--shiki-light:#383A42;">=</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">user_id).</span><span style="--shiki-dark:#61AFEF;--shiki-light:#383A42;">update</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#986801;--shiki-light-font-style:inherit;">name</span><span style="--shiki-dark:#56B6C2;--shiki-light:#383A42;">=</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">name)</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">    return</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> {</span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">&quot;message&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">: </span><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">&quot;updated&quot;</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>执行更新后 → 自动删除 L1 和 Redis 缓存</li><li>通过 Pub/Sub 广播 → 通知其他节点清理本地 L1 缓存</li></ul><h2 id="对比" tabindex="-1"><a class="header-anchor" href="#对比"><span>对比</span></a></h2><table><thead><tr><th>维度</th><th>编程式缓存</th><th>声明式缓存（装饰器）</th></tr></thead><tbody><tr><td>代码量</td><td>多（每个地方都要写 get/set/delete）</td><td>极少（一行装饰器即可）</td></tr><tr><td>一致性保障</td><td>需手动保证（容易遗漏失效）</td><td>自动处理 + Pub/Sub 广播</td></tr><tr><td>灵活性</td><td>最高</td><td>较高（支持 key_builder）</td></tr><tr><td>开发效率</td><td>较低</td><td>高</td></tr><tr><td>维护成本</td><td>高（修改逻辑需改多处）</td><td>低（改装饰器参数即可）</td></tr><tr><td>适用场景</td><td>复杂缓存策略、批量、预热、特殊数据</td><td>标准 CRUD、列表、详情、热点数据</td></tr><tr><td>调试难度</td><td>低（逻辑显式）</td><td>中等（需理解装饰器内部流程）</td></tr></tbody></table><h2 id="使用策略" tabindex="-1"><a class="header-anchor" href="#使用策略"><span>使用策略</span></a></h2><p>大多数项目推荐以下模式：</p><ul><li><strong>特殊场景</strong> → 使用编程式手动操作</li><li><strong>读操作</strong>（详情、列表、热点数据） → 使用 <code>@cached</code> 声明式缓存</li><li><strong>删/改操作</strong> → 使用 <code>@cache_invalidate</code> 声明式失效</li><li><strong>开启本地缓存</strong> → L1（内存）缓存将进一步提速，L2（Redis）作为持久层</li><li><strong>追求开发效率和代码简洁</strong> → 优先使用声明式缓存</li><li><strong>需要精细控制、复杂逻辑</strong> → 使用编程式缓存</li></ul>`,20)])])}const d=s(n,[["render",h]]),r=JSON.parse('{"path":"/backend/reference/cache.html","title":"缓存","lang":"zh-CN","frontmatter":{"title":"缓存","description":"编程式缓存 完全手动控制缓存的读写、失效、TTL 等 适合复杂逻辑、批量操作、自定义序列化、事务等高级场景 代码较为显式，易于调试，但重复代码多，容易出错 依赖 所有操作都通过 backend/database/redis.py 中的全局 Redis 客户端完成： 声明式缓存 通过装饰器自动管理缓存生命周期 代码极简，关注点分离，适合标准 CRUD @...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"缓存\\",\\"image\\":[\\"\\"],\\"dateModified\\":null,\\"author\\":[]}"],["meta",{"property":"og:url","content":"https://fastapi-practices.github.io/fastapi_best_architecture_docs/fastapi_best_architecture_docs/backend/reference/cache.html"}],["meta",{"property":"og:site_name","content":"FastAPI Best Architecture"}],["meta",{"property":"og:title","content":"缓存"}],["meta",{"property":"og:description","content":"编程式缓存 完全手动控制缓存的读写、失效、TTL 等 适合复杂逻辑、批量操作、自定义序列化、事务等高级场景 代码较为显式，易于调试，但重复代码多，容易出错 依赖 所有操作都通过 backend/database/redis.py 中的全局 Redis 客户端完成： 声明式缓存 通过装饰器自动管理缓存生命周期 代码极简，关注点分离，适合标准 CRUD @..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}]]},"readingTime":{"minutes":1.8,"words":540},"git":{"createdTime":1770451674000},"autoDesc":true,"filePathRelative":"backend/reference/cache.md","headers":[],"bulletin":false}');export{d as comp,r as data};
