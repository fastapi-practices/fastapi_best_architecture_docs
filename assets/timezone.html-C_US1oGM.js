import{_ as s,c as a,d as t,o as e}from"./app-BLJpD-6k.js";const n="/fastapi_best_architecture_docs/images/question_db_timezone.png",l="/fastapi_best_architecture_docs/images/question_sql_timezone.png",h={};function p(k,i){return e(),a("div",null,[...i[0]||(i[0]=[t('<p>我们为全局精心设计了统一时区，现在，这是一件非常轻松的工作，只需修改 <code>backend/core/conf.py</code> 中的时区配置即可改变全局时区</p><div class="hint-container caution"><p class="hint-container-title">警告</p><p>时区一旦确定，强烈建议不要后期修改，否则可能造成持久化数据时间信息紊乱！</p></div><h2 id="架构应用" tabindex="-1"><a class="header-anchor" href="#架构应用"><span>架构应用</span></a></h2><p>无论在架构何处调用时间模块，我们都应使用 <code>backend/utils/timezone.py</code> 中提供的现有方法，而不是直接调用 datetime 相关模块</p><h2 id="数据库" tabindex="-1"><a class="header-anchor" href="#数据库"><span>数据库</span></a></h2><p>在数据库中处理时区是一件令人头疼的事，常见的方式有以下 3 种：</p><ul><li>全部存读为 UTC，前端转化（利于国际化管理）</li><li>全部存读当前时区时间，根据前端传入的时区进行转换（利于本地化管理）</li><li>全部存储为数值时间戳，前端转化（极其不易管理，但易操作）</li></ul><p>让我们来看一个经典案例：</p><div class="vp-chat"><div class="vp-chat-header"><p class="vp-chat-title">群聊</p></div><div class="vp-chat-content"><div class="vp-chat-date"><span>2025-08-26 12:44:00</span></div><div class="vp-chat-message user"><div class="vp-chat-message-body"><p class="vp-chat-username">王</p><div class="message-content"><p>请教大佬，为啥我查询的时间用的不同的时区和时间戳，返回的数据却是一样的？</p><p><img src="'+n+'" alt="question_db_timezone"></p><p>数据库用的是 mysql，原则上这两个 datetime 的时间戳是不一样的，但是查出来的数据是一样的结果；</p></div></div></div><div class="vp-chat-message user"><div class="vp-chat-message-body"><p class="vp-chat-username">王</p><div class="message-content"><p>我直接写 sql 查询，这个两个是符合预期结果的，第一个有数据，第二个查不到；</p><p><img src="'+l+`" alt="question_sql_timezone"></p><p>这个切换到pg数据库后查询符合预期结果的；</p></div></div></div><div class="vp-chat-message self"><div class="vp-chat-message-body"><div class="message-content"><p><strong>timezone</strong>: not used by the MySQL dialect.</p><p>sqlalchemy 和所有 python mysql 驱动默认都不处理 mysql 时区信息，通常是直接丢弃，即便使用 TIMESTAMP 类型</p></div></div></div><div class="vp-chat-message self"><div class="vp-chat-message-body"><div class="message-content"><p>更具体的：<a href="https://github.com/sqlalchemy/sqlalchemy/issues/1985" target="_blank" rel="noopener noreferrer">sqlalchemy/1985</a></p></div></div></div></div></div><p>为此，我们使用了第 2 种解决方案，并创建了自定义 TimeZone 类型</p><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" style="--shiki-dark:#abb2bf;--shiki-light:#383A42;--shiki-dark-bg:#282c34;--shiki-light-bg:#FAFAFA;"><pre class="shiki shiki-themes one-dark-pro one-light vp-code"><code class="language-python"><span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">class</span><span style="--shiki-dark:#E5C07B;--shiki-light:#C18401;"> TimeZone</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#C18401;">(TypeDecorator[datetime])</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">:</span></span>
<span class="line"><span style="--shiki-dark:#98C379;--shiki-light:#50A14F;">    &quot;&quot;&quot;PostgreSQL、MySQL 兼容性时区感知类型&quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">    impl </span><span style="--shiki-dark:#56B6C2;--shiki-light:#383A42;">=</span><span style="--shiki-dark:#61AFEF;--shiki-light:#383A42;"> DateTime</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#986801;--shiki-light-font-style:inherit;">timezone</span><span style="--shiki-dark:#56B6C2;--shiki-light:#383A42;">=</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;">True</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">)</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">    cache_ok </span><span style="--shiki-dark:#56B6C2;--shiki-light:#383A42;">=</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> True</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;">    @</span><span style="--shiki-dark:#56B6C2;--shiki-light:#0184BC;">property</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">    def</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> python_type</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E5C07B;--shiki-dark-font-style:italic;--shiki-light:#986801;--shiki-light-font-style:inherit;">self</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">) -&gt; type[datetime]:</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">        return</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> datetime</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">    def</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> process_bind_param</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E5C07B;--shiki-dark-font-style:italic;--shiki-light:#986801;--shiki-light-font-style:inherit;">self</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">,</span><span style="--shiki-dark:#D19A66;--shiki-dark-font-style:italic;--shiki-light:#986801;--shiki-light-font-style:inherit;"> value</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">:</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#986801;"> datetime </span><span style="--shiki-dark:#56B6C2;--shiki-light:#383A42;">|</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> None</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">,</span><span style="--shiki-dark:#D19A66;--shiki-dark-font-style:italic;--shiki-light:#986801;--shiki-light-font-style:inherit;"> dialect</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">) -&gt; datetime </span><span style="--shiki-dark:#56B6C2;--shiki-light:#383A42;">|</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> None</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">:  </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#A0A1A7;--shiki-light-font-style:italic;"># noqa: ANN001</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">        if</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> value </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">is</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> not</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> None</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> and</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> value.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#383A42;">utcoffset</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">() </span><span style="--shiki-dark:#56B6C2;--shiki-light:#383A42;">!=</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> timezone.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#383A42;">now</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">().</span><span style="--shiki-dark:#61AFEF;--shiki-light:#383A42;">utcoffset</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">():</span></span>
<span class="line"><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#A0A1A7;--shiki-light-font-style:italic;">            # </span><span style="--shiki-dark:#C678DD;--shiki-dark-font-style:italic;--shiki-light:#A626A4;--shiki-light-font-style:italic;">TODO</span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#A0A1A7;--shiki-light-font-style:italic;"> 处理夏令时偏移</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">            value </span><span style="--shiki-dark:#56B6C2;--shiki-light:#383A42;">=</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> timezone.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#383A42;">from_datetime</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(value)</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">        return</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> value</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">    def</span><span style="--shiki-dark:#61AFEF;--shiki-light:#4078F2;"> process_result_value</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E5C07B;--shiki-dark-font-style:italic;--shiki-light:#986801;--shiki-light-font-style:inherit;">self</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">,</span><span style="--shiki-dark:#D19A66;--shiki-dark-font-style:italic;--shiki-light:#986801;--shiki-light-font-style:inherit;"> value</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">:</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#986801;"> datetime </span><span style="--shiki-dark:#56B6C2;--shiki-light:#383A42;">|</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> None</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">,</span><span style="--shiki-dark:#D19A66;--shiki-dark-font-style:italic;--shiki-light:#986801;--shiki-light-font-style:inherit;"> dialect</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">) -&gt; datetime </span><span style="--shiki-dark:#56B6C2;--shiki-light:#383A42;">|</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> None</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">:  </span><span style="--shiki-dark:#7F848E;--shiki-dark-font-style:italic;--shiki-light:#A0A1A7;--shiki-light-font-style:italic;"># noqa: ANN001</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">        if</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> value </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">is</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> not</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> None</span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;"> and</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> value.tzinfo </span><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">is</span><span style="--shiki-dark:#D19A66;--shiki-light:#986801;"> None</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">:</span></span>
<span class="line"><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">            value </span><span style="--shiki-dark:#56B6C2;--shiki-light:#383A42;">=</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> value.</span><span style="--shiki-dark:#61AFEF;--shiki-light:#383A42;">replace</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">(</span><span style="--shiki-dark:#E06C75;--shiki-dark-font-style:italic;--shiki-light:#986801;--shiki-light-font-style:inherit;">tzinfo</span><span style="--shiki-dark:#56B6C2;--shiki-light:#383A42;">=</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;">timezone.tz_info)</span></span>
<span class="line"><span style="--shiki-dark:#C678DD;--shiki-light:#A626A4;">        return</span><span style="--shiki-dark:#ABB2BF;--shiki-light:#383A42;"> value</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,11)])])}const r=s(h,[["render",p]]),c=JSON.parse('{"path":"/backend/reference/timezone.html","title":"时区","lang":"zh-CN","frontmatter":{"title":"时区","description":"我们为全局精心设计了统一时区，现在，这是一件非常轻松的工作，只需修改 backend/core/conf.py 中的时区配置即可改变全局时区 警告 时区一旦确定，强烈建议不要后期修改，否则可能造成持久化数据时间信息紊乱！ 架构应用 无论在架构何处调用时间模块，我们都应使用 backend/utils/timezone.py 中提供的现有方法，而不是直接...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"时区\\",\\"image\\":[\\"https://fastapi-practices.github.io/fastapi_best_architecture_docs/fastapi_best_architecture_docs/images/question_db_timezone.png\\",\\"https://fastapi-practices.github.io/fastapi_best_architecture_docs/fastapi_best_architecture_docs/images/question_sql_timezone.png\\"],\\"dateModified\\":null,\\"author\\":[]}"],["meta",{"property":"og:url","content":"https://fastapi-practices.github.io/fastapi_best_architecture_docs/fastapi_best_architecture_docs/backend/reference/timezone.html"}],["meta",{"property":"og:site_name","content":"FastAPI Best Architecture"}],["meta",{"property":"og:title","content":"时区"}],["meta",{"property":"og:description","content":"我们为全局精心设计了统一时区，现在，这是一件非常轻松的工作，只需修改 backend/core/conf.py 中的时区配置即可改变全局时区 警告 时区一旦确定，强烈建议不要后期修改，否则可能造成持久化数据时间信息紊乱！ 架构应用 无论在架构何处调用时间模块，我们都应使用 backend/utils/timezone.py 中提供的现有方法，而不是直接..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://fastapi-practices.github.io/fastapi_best_architecture_docs/fastapi_best_architecture_docs/images/question_db_timezone.png"}],["meta",{"property":"og:locale","content":"zh-CN"}]]},"readingTime":{"minutes":1.79,"words":538},"git":{"createdTime":1756282182000},"autoDesc":true,"filePathRelative":"backend/reference/timezone.md","headers":[],"bulletin":false}');export{r as comp,c as data};
